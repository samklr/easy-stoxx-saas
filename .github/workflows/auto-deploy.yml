name: Auto Deploy on Push

# This workflow automatically deploys to dev environment when code is pushed to develop branch
# and to staging when code is pushed to main branch

on:
  push:
    branches:
      - main
      - develop

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image-tag: ${{ steps.set-env.outputs.image-tag }}
      backend-service: ${{ steps.set-env.outputs.backend-service }}
      frontend-service: ${{ steps.set-env.outputs.frontend-service }}

    steps:
      - name: Set environment based on branch
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "image-tag=latest" >> $GITHUB_OUTPUT
            echo "backend-service=hotel-saas-backend-staging" >> $GITHUB_OUTPUT
            echo "frontend-service=hotel-saas-frontend-staging" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "image-tag=develop" >> $GITHUB_OUTPUT
            echo "backend-service=hotel-saas-backend-dev" >> $GITHUB_OUTPUT
            echo "frontend-service=hotel-saas-frontend-dev" >> $GITHUB_OUTPUT
          else
            echo "environment=unknown" >> $GITHUB_OUTPUT
            echo "image-tag=unknown" >> $GITHUB_OUTPUT
          fi

  build-and-deploy-backend:
    name: Build & Deploy Backend
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.environment != 'unknown'
    environment: ${{ needs.determine-environment.outputs.environment }}

    permissions:
      contents: read
      id-token: write

    outputs:
      backend-url: ${{ steps.get-backend-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run backend tests
        working-directory: ./backend
        run: mvn clean test

      - name: Build backend
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and Push Backend Image
        run: |
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-backend:${{ github.sha }} \
                       -t gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-backend:${{ needs.determine-environment.outputs.image-tag }} \
                       ./backend
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-backend:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-backend:${{ needs.determine-environment.outputs.image-tag }}

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy ${{ needs.determine-environment.outputs.backend-service }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-backend:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --add-cloudsql-instances ${{ secrets.CLOUD_SQL_INSTANCE }} \
            --set-env-vars "SPRING_PROFILES_ACTIVE=prod" \
            --set-env-vars "CLOUD_SQL_INSTANCE=${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars "DB_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars "DB_USER=${{ secrets.DB_USER }}" \
            --set-secrets "DB_PASSWORD=db-password:latest" \
            --set-env-vars "GCS_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" \
            --set-env-vars "GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}" \
            --min-instances 0 \
            --max-instances 5 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --port 8080 \
            --quiet

      - name: Get Backend URL
        id: get-backend-url
        run: |
          URL=$(gcloud run services describe ${{ needs.determine-environment.outputs.backend-service }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Test Backend Health
        run: |
          sleep 10
          curl -f ${{ steps.get-backend-url.outputs.url }}/actuator/health || exit 1

  build-and-deploy-frontend:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-deploy-backend]
    if: needs.determine-environment.outputs.environment != 'unknown'
    environment: ${{ needs.determine-environment.outputs.environment }}

    permissions:
      contents: read
      id-token: write

    outputs:
      frontend-url: ${{ steps.get-frontend-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run linter
        working-directory: ./frontend
        run: npm run lint || true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and Push Frontend Image
        run: |
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-frontend:${{ github.sha }} \
                       -t gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-frontend:${{ needs.determine-environment.outputs.image-tag }} \
                       ./frontend
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-frontend:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-frontend:${{ needs.determine-environment.outputs.image-tag }}

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ needs.determine-environment.outputs.frontend-service }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/hotel-saas-frontend:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "NEXT_PUBLIC_API_URL=${{ needs.build-and-deploy-backend.outputs.backend-url }}" \
            --min-instances 0 \
            --max-instances 5 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --port 3000 \
            --quiet

      - name: Get Frontend URL
        id: get-frontend-url
        run: |
          URL=$(gcloud run services describe ${{ needs.determine-environment.outputs.frontend-service }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Test Frontend
        run: |
          sleep 10
          curl -f ${{ steps.get-frontend-url.outputs.url }} || exit 1

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-deploy-backend, build-and-deploy-frontend]
    if: success()

    steps:
      - name: Create deployment summary
        run: |
          echo "# ðŸš€ Auto-Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** ${{ needs.build-and-deploy-backend.outputs.backend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** ${{ needs.build-and-deploy-frontend.outputs.frontend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Deployed at $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)*" >> $GITHUB_STEP_SUMMARY
